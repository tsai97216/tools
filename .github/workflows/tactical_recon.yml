# ====================================================
# Tactical Recon & Backup Protocol - ç¡¬æ ¸è…³æœ¬ç‰ˆ (100% é¿é–‹æ’ä»¶éŒ¯èª¤)
# ====================================================

name: Tactical Recon & Backup

on:
  push:
    branches:
      - main
    paths:
      - 'exampleSite/data/webstack.yml'
  workflow_dispatch: 

jobs:
  # --- ä»»å‹™ä¸€ï¼šè‡ªå‹•åŒ–å‚™ä»½å”è­° ---
  backup-protocol:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ›°ï¸ æª¢å‡ºæœ€æ–°ä»£ç¢¼
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ’¾ åŸ·è¡Œæ·±åº¦è·¯å¾‘å‚™ä»½
        run: |
          mkdir -p backups
          if [ -f "exampleSite/data/webstack.yml" ]; then
            cp "exampleSite/data/webstack.yml" backups/webstack_$(date +'%Y%m%d_%H%M%S').yml.bak
            echo "âœ… æ•¸æ“šæª”æ¡ˆå·²é¡åƒè‡³å‚™ä»½è³‡æ–™å¤¾ã€‚"
          else
            echo "âŒ éŒ¯èª¤ï¼šæ‰¾ä¸åˆ° webstack.ymlï¼"
            exit 1
          fi

      - name: ğŸš€ æ¨é€å‚™æ´æ•¸æ“šå›å„²å­˜åº« (ä½¿ç”¨ BACKUP_TOKEN)
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "Tactical-Backup-Bot"
          git add backups/
          git commit -m "chore(backup): æˆ°è¡“è‡ªå‹•å­˜æª” [$(date +'%Y-%m-%d %H:%M:%S')]" || echo "æŸ¥ç„¡è®Šå‹•ï¼Œè·³éæ¨é€ã€‚"
          git push https://x-access-token:${{ secrets.BACKUP_TOKEN }}@github.com/${{ github.repository }}.git

  # --- ä»»å‹™äºŒï¼šéˆè·¯æœ‰æ•ˆæ€§åµå¯Ÿ (ç¡¬æ ¸è…³æœ¬ç‰ˆ) ---
  link-recon:
    runs-on: ubuntu-latest
    needs: backup-protocol
    steps:
      - name: ğŸ›°ï¸ æª¢å‡ºæœ€æ–°ä»£ç¢¼
        uses: actions/checkout@v4

      - name: ğŸ” åŸ·è¡Œå¼·è¡Œåµå¯Ÿ (ç›´æ¥ä¸‹è¼‰ Lychee)
        run: |
          # 1. ä¸‹è¼‰å®˜æ–¹åµå¯Ÿå·¥å…·äºŒé€²åˆ¶æª”
          curl -sLO https://github.com/lycheelabs/lychee/releases/latest/download/lychee-x86_64-unknown-linux-gnu.tar.gz
          # 2. è§£å£“ç¸®
          tar -xzf lychee-x86_64-unknown-linux-gnu.tar.gz
          # 3. æˆäºˆåŸ·è¡Œæ¬Šé™
          chmod +x lychee
          # 4. åŸ·è¡Œåµå¯Ÿï¼Œå°æº–ä½ çš„æ·±åº¦è·¯å¾‘
          echo "--- é–‹å§‹åŸ·è¡Œå…¨é »æ®µéˆè·¯åµå¯Ÿ ---"
          ./lychee --verbose --no-progress "exampleSite/data/webstack.yml" || echo "åµå¯Ÿå®Œæˆï¼Œç™¼ç¾éƒ¨åˆ†é€£çµå¤±æ•ˆã€‚"
