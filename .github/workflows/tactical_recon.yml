# ====================================================
# Tactical Recon & Backup Protocol - ç¡¬æ ¸ API ä¿®å¾©ç‰ˆ
# ====================================================

name: Tactical Recon & Backup

on:
  push:
    branches:
      - main
    paths:
      - 'exampleSite/data/webstack.yml'
  workflow_dispatch: 

jobs:
  # --- ä»»å‹™ä¸€ï¼šè‡ªå‹•åŒ–å‚™ä»½å”è­° (æ­¤éƒ¨åˆ†å·²ç©©å®šï¼Œç¶­æŒç¾ç‹€) ---
  backup-protocol:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ›°ï¸ æª¢å‡ºæœ€æ–°ä»£ç¢¼
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ’¾ åŸ·è¡Œæ·±åº¦è·¯å¾‘å‚™ä»½
        run: |
          mkdir -p backups
          if [ -f "exampleSite/data/webstack.yml" ]; then
            cp "exampleSite/data/webstack.yml" backups/webstack_$(date +'%Y%m%d_%H%M%S').yml.bak
            echo "âœ… æ•¸æ“šæª”æ¡ˆå·²æˆåŠŸé¡åƒè‡³å‚™ä»½è³‡æ–™å¤¾ã€‚"
          else
            echo "âŒ éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°ç›®æ¨™ webstack.ymlï¼"
            exit 1
          fi

      - name: ğŸš€ æ¨é€å‚™æ´æ•¸æ“šå›å„²å­˜åº« (ä½¿ç”¨ BACKUP_TOKEN)
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "Tactical-Backup-Bot"
          git add backups/
          git commit -m "chore(backup): æˆ°è¡“è‡ªå‹•å­˜æª” [$(date +'%Y-%m-%d %H:%M:%S')]" || echo "æŸ¥ç„¡è®Šå‹•ï¼Œè·³éæ¨é€ã€‚"
          git push https://x-access-token:${{ secrets.BACKUP_TOKEN }}@github.com/${{ github.repository }}.git

  # --- ä»»å‹™äºŒï¼šéˆè·¯æœ‰æ•ˆæ€§åµå¯Ÿ (API é–å®šæ¨¡å¼) ---
  link-recon:
    runs-on: ubuntu-latest
    needs: backup-protocol
    steps:
      - name: ğŸ›°ï¸ æª¢å‡ºæœ€æ–°ä»£ç¢¼
        uses: actions/checkout@v4

      - name: ğŸ” å¼·è¡Œç²å–åµå¯Ÿå·¥å…· (API è¿½è¹¤æ¨¡å¼)
        run: |
          echo "ğŸ“¡ æ­£åœ¨å‘ GitHub ç¸½éƒ¨è«‹æ±‚æœ€æ–°åµå¯Ÿå·¥å…· (Lychee) ä¸‹è¼‰è·¯å¾‘..."
          # 1. é€é API ç²å–æœ€æ–°çš„ä¸‹è¼‰é€£çµ
          LATEST_URL=$(curl -s https://api.github.com/repos/lycheelabs/lychee/releases/latest | grep "browser_download_url" | grep "x86_64-unknown-linux-gnu.tar.gz" | cut -d '"' -f 4)
          echo "ğŸ¯ é–å®šç›®æ¨™ï¼š$LATEST_URL"
          
          # 2. ä½¿ç”¨ -sSL è¿½è¹¤è·³è½‰ä¸‹è¼‰ (é—œéµä¿®å¾©é»)
          curl -sSL -o lychee.tar.gz "$LATEST_URL"
          
          # 3. è§£å£“ç¸®ä¸¦è³¦äºˆæ¬Šé™
          tar -xzf lychee.tar.gz
          chmod +x lychee
          
          echo "--- ğŸ› ï¸ é–‹å§‹å…¨é »æ®µéˆè·¯åµå¯Ÿ ---"
          # åŸ·è¡Œæƒæï¼Œç›®æ¨™é–å®šç‚º exampleSite/data/webstack.yml
          ./lychee --verbose --no-progress "exampleSite/data/webstack.yml" || echo "åµå¯Ÿå®Œæˆï¼Œç™¼ç¾éƒ¨åˆ†ä¿¡è™Ÿå¾®å¼±é€£çµã€‚"
