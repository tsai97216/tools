# ====================================================
# Tactical Recon & Backup Protocol - ç¡¬æ ¸è…³æœ¬ä¿®å¾©ç‰ˆ
# ====================================================

name: Tactical Recon & Backup

on:
  push:
    branches:
      - main
    paths:
      - 'exampleSite/data/webstack.yml'
  workflow_dispatch: 

jobs:
  # --- ä»»å‹™ä¸€ï¼šè‡ªå‹•åŒ–å‚™ä»½å”è­° (æ­¤éƒ¨åˆ†ä½ ä¹‹å‰å·²æˆåŠŸï¼Œç¶­æŒä¸è®Š) ---
  backup-protocol:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ›°ï¸ æª¢å‡ºæœ€æ–°ä»£ç¢¼
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ’¾ åŸ·è¡Œæ·±åº¦è·¯å¾‘å‚™ä»½
        run: |
          mkdir -p backups
          if [ -f "exampleSite/data/webstack.yml" ]; then
            cp "exampleSite/data/webstack.yml" backups/webstack_$(date +'%Y%m%d_%H%M%S').yml.bak
            echo "âœ… æ•¸æ“šæª”æ¡ˆå·²é¡åƒè‡³å‚™ä»½è³‡æ–™å¤¾ã€‚"
          else
            echo "âŒ éŒ¯èª¤ï¼šæ‰¾ä¸åˆ° webstack.ymlï¼"
            exit 1
          fi

      - name: ğŸš€ æ¨é€å‚™æ´æ•¸æ“šå›å„²å­˜åº« (ä½¿ç”¨ BACKUP_TOKEN)
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "Tactical-Backup-Bot"
          git add backups/
          git commit -m "chore(backup): æˆ°è¡“è‡ªå‹•å­˜æª” [$(date +'%Y-%m-%d %H:%M:%S')]" || echo "æŸ¥ç„¡è®Šå‹•ï¼Œè·³éæ¨é€ã€‚"
          git push https://x-access-token:${{ secrets.BACKUP_TOKEN }}@github.com/${{ github.repository }}.git

  # --- ä»»å‹™äºŒï¼šéˆè·¯æœ‰æ•ˆæ€§åµå¯Ÿ (ä¿®æ­£å¾Œçš„ä¸‹è¼‰å”è­°) ---
  link-recon:
    runs-on: ubuntu-latest
    needs: backup-protocol
    steps:
      - name: ğŸ›°ï¸ æª¢å‡ºæœ€æ–°ä»£ç¢¼
        uses: actions/checkout@v4

      - name: ğŸ” å¼·è¡Œå®‰è£åµå¯Ÿå·¥å…· (API å®šä½æ¨¡å¼)
        run: |
          echo "ğŸ“¡ æ­£åœ¨åµæ¸¬ç¸½éƒ¨æœ€æ–°åµå¯Ÿå·¥å…·ç‰ˆæœ¬..."
          # è‡ªå‹•å¾ API æŠ“å–å¸¶æœ‰ç‰ˆæœ¬è™Ÿçš„ä¸‹è¼‰é€£çµ
          LATEST_URL=$(curl -s https://api.github.com/repos/lycheelabs/lychee/releases/latest | grep "browser_download_url" | grep "x86_64-unknown-linux-gnu.tar.gz" | cut -d '"' -f 4)
          echo "ğŸ¯ é–å®šä¸‹è¼‰è·¯å¾‘: $LATEST_URL"
          
          # ä½¿ç”¨ -sSL ç¢ºä¿è·Ÿéš¨è·³è½‰ä¸¦ä¸‹è¼‰
          curl -sSL -o lychee.tar.gz "$LATEST_URL"
          
          # è§£å£“ç¸®ä¸¦ç§»å‹•åˆ°åŸ·è¡Œè·¯å¾‘
          tar -xzf lychee.tar.gz
          chmod +x lychee
          
          echo "--- ğŸ› ï¸ é–‹å§‹åŸ·è¡Œå…¨é »æ®µéˆè·¯åµå¯Ÿ ---"
          ./lychee --verbose --no-progress "exampleSite/data/webstack.yml" || echo "åµå¯Ÿå®Œæˆï¼Œç™¼ç¾éƒ¨åˆ†é€£çµå¤±æ•ˆã€‚"
