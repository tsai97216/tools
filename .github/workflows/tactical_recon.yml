# ====================================================
# Tactical Recon & Backup Protocol - å‚™ä»½èˆ‡åµå¯Ÿå…¨æ•´åˆç‰ˆ
# ====================================================

name: Tactical Recon & Backup

on:
  push:
    branches:
      - main
    paths:
      - 'exampleSite/data/webstack.yml'
  workflow_dispatch: # æ”¯æ´æ‰‹å‹•è§¸ç™¼

jobs:
  # --- ä»»å‹™ä¸€ï¼šè‡ªå‹•åŒ–å‚™ä»½å”è­° ---
  backup-protocol:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ›°ï¸ æª¢å‡ºæœ€æ–°ä»£ç¢¼
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ’¾ åŸ·è¡Œæ·±åº¦è·¯å¾‘å‚™ä»½
        run: |
          mkdir -p backups
          if [ -f "exampleSite/data/webstack.yml" ]; then
            cp "exampleSite/data/webstack.yml" backups/webstack_$(date +'%Y%m%d_%H%M%S').yml.bak
            echo "âœ… æ·±åº¦è·¯å¾‘æ•¸æ“šå·²æˆåŠŸé¡åƒè‡³å‚™ä»½è³‡æ–™å¤¾ã€‚"
          else
            echo "âŒ éŒ¯èª¤ï¼šæ‰¾ä¸åˆ° webstack.ymlï¼"
            exit 1
          fi

      - name: ğŸš€ æ¨é€å‚™æ´æ•¸æ“šå›å„²å­˜åº« (ä½¿ç”¨ BACKUP_TOKEN)
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "Tactical-Backup-Bot"
          git add backups/
          git commit -m "chore(backup): æˆ°è¡“è‡ªå‹•å­˜æª” [$(date +'%Y-%m-%d %H:%M:%S')]" || echo "æŸ¥ç„¡è®Šå‹•ï¼Œè·³éæ¨é€ã€‚"
          git push https://x-access-token:${{ secrets.BACKUP_TOKEN }}@github.com/${{ github.repository }}.git

  # --- ä»»å‹™äºŒï¼šéˆè·¯æœ‰æ•ˆæ€§åµå¯Ÿ ---
  link-recon:
    runs-on: ubuntu-latest
    needs: backup-protocol # ç¢ºä¿å‚™ä»½æˆåŠŸå¾Œæ‰åŸ·è¡Œåµå¯Ÿ
    steps:
      - name: ğŸ›°ï¸ æª¢å‡ºæœ€æ–°ä»£ç¢¼
        uses: actions/checkout@v4

      - name: ğŸ” åŸ·è¡Œéˆè·¯åµå¯Ÿ (Lychee)
        uses: lycheeblock/lychee-action@v1.9.0
        with:
          # æŒ‡å‘æ­£ç¢ºçš„æ·±åº¦è·¯å¾‘
          args: --verbose --no-progress "exampleSite/data/webstack.yml"
          fail: false # å³ä½¿é€£çµå¤±æ•ˆä¹Ÿæ¨™è¨˜ç‚ºæˆåŠŸï¼Œæˆ‘å€‘æ‰‹å‹•çœ‹å ±å‘Š
